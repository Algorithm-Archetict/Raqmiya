<div class="product-edit-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card glass-card">
          <div class="card-header gradient-header">
            <h2 class="card-title">
              <i class="fas fa-edit me-2"></i>Edit Product
            </h2>
            <p class="card-subtitle">Update your product information and files</p>
          </div>

          <div class="card-body">
            <!-- Loading and Alert Messages -->
            <app-loading-spinner *ngIf="isLoading && !product"></app-loading-spinner>
            <app-alert *ngIf="errorMessage" [message]="errorMessage" type="danger"></app-alert>
            <app-alert *ngIf="successMessage" [message]="successMessage" type="success"></app-alert>

            <!-- Progress Bar -->
            <div class="progress mb-4" style="height: 8px;">
              <div class="progress-bar gradient-progress" role="progressbar" 
                   [style.width.%]="getFormProgress()" 
                   [attr.aria-valuenow]="getFormProgress()" 
                   aria-valuemin="0" aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted mb-4 d-block">Form completion: {{ getFormProgress() }}%</small>

            <form *ngIf="!isLoading && product" [formGroup]="productForm" (ngSubmit)="onUpdateProduct()">
              <!-- Basic Information Section -->
              <div class="form-section">
                <h3 class="section-title">
                  <i class="fas fa-info-circle me-2"></i>Basic Information
                </h3>

                <div class="row">
                  <div class="col-md-8">
                    <div class="form-group">
                      <label for="name" class="form-label">Product Name *</label>
                      <input type="text" id="name" formControlName="name" class="form-control"
                        [class.is-invalid]="isFieldInvalid('name')"
                        placeholder="e.g., Ultimate Productivity Planner">
                      <div class="invalid-feedback" *ngIf="getFieldError('name')">
                        {{ getFieldError('name') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="productType" class="form-label">Product Type *</label>
                      <select id="productType" formControlName="productType" class="form-select"
                        [class.is-invalid]="isFieldInvalid('productType')">
                        <option value="">Select type</option>
                        <option *ngFor="let type of productTypes" [value]="type">{{ type }}</option>
                      </select>
                      <div class="invalid-feedback" *ngIf="getFieldError('productType')">
                        {{ getFieldError('productType') }}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="description" class="form-label">Description</label>
                  <textarea id="description" formControlName="description" class="form-control" rows="4"
                    [class.is-invalid]="isFieldInvalid('description')"
                    placeholder="A detailed description of your product..."></textarea>
                  <div class="invalid-feedback" *ngIf="getFieldError('description')">
                    {{ getFieldError('description') }}
                  </div>
                  <div class="form-text">
                    <span [class.text-danger]="productForm.get('description')?.value?.length > 4500">
                      {{ productForm.get('description')?.value?.length || 0 }}/5000 characters
                    </span>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="price" class="form-label">Price *</label>
                      <div class="input-group">
                        <span class="input-group-text">{{ productForm.get('currency')?.value || 'USD' }}</span>
                        <input type="number" id="price" formControlName="price" class="form-control"
                          [class.is-invalid]="isFieldInvalid('price')"
                          placeholder="0.00" step="0.01" min="0.01">
                      </div>
                      <div class="invalid-feedback" *ngIf="getFieldError('price')">
                        {{ getFieldError('price') }}
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="currency" class="form-label">Currency *</label>
                      <select id="currency" formControlName="currency" class="form-select"
                        [class.is-invalid]="isFieldInvalid('currency')">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                      </select>
                      <div class="invalid-feedback" *ngIf="getFieldError('currency')">
                        {{ getFieldError('currency') }}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="permalink" class="form-label">Permalink *</label>
                  <input type="text" id="permalink" formControlName="permalink" class="form-control"
                    [class.is-invalid]="isFieldInvalid('permalink')"
                    placeholder="e.g., ultimate-productivity-planner">
                  <div class="invalid-feedback" *ngIf="getFieldError('permalink')">
                    {{ getFieldError('permalink') }}
                  </div>
                  <div class="form-text">URL-friendly identifier for your product (lowercase, hyphens only)</div>
                </div>
              </div>

              <!-- File Upload Section -->
              <div class="form-section">
                <h3 class="section-title">
                  <i class="fas fa-upload me-2"></i>Files & Media
                </h3>

                <!-- Digital Product File -->
                <div class="form-group">
                  <label for="digitalProductFile" class="form-label">Digital Product File</label>
                  <div class="file-upload-container">
                    <input type="file" id="digitalProductFile" class="form-control" 
                           (change)="onDigitalProductSelected($event)" accept=".zip,.rar,.pdf,.txt,.json,.xml,image/*,video/*">
                    <div class="file-info" *ngIf="selectedDigitalProduct">
                      <span class="file-name">{{ selectedDigitalProduct.name }}</span>
                      <button type="button" class="btn btn-sm btn-outline-danger" (click)="onClearDigitalProduct()">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="form-text">Upload your main digital product file (ZIP, RAR, images, videos, etc.)</div>
                </div>

                <!-- Cover Image -->
                <div class="form-group">
                  <label for="coverImageFile" class="form-label">Cover Image</label>
                  <div class="file-upload-container">
                    <input type="file" id="coverImageFile" class="form-control" 
                           (change)="onCoverImageSelected($event)" accept="image/*">
                    <div class="file-info" *ngIf="selectedCoverImage">
                      <span class="file-name">{{ selectedCoverImage.name }}</span>
                      <button type="button" class="btn btn-sm btn-outline-danger" (click)="onClearCoverImage()">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="form-text">Upload a cover image for your product (JPG, PNG, GIF, WebP)</div>
                </div>

                <!-- Image Preview -->
                <div class="form-group" *ngIf="imagePreview">
                  <label class="form-label">Image Preview</label>
                  <div class="image-preview-container">
                    <img [src]="imagePreview" alt="Cover image preview" class="img-thumbnail">
                  </div>
                </div>

                <!-- Preview Video -->
                <div class="form-group">
                  <label for="previewVideoFile" class="form-label">Preview Video</label>
                  <div class="file-upload-container">
                    <input type="file" id="previewVideoFile" class="form-control" 
                           (change)="onPreviewVideoSelected($event)" accept="video/*">
                    <div class="file-info" *ngIf="selectedPreviewVideo">
                      <span class="file-name">{{ selectedPreviewVideo.name }}</span>
                      <button type="button" class="btn btn-sm btn-outline-danger" (click)="onClearPreviewVideo()">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="form-text">Upload a preview video for your product (MP4, AVI, MOV, etc.)</div>
                </div>

                <!-- Video Preview -->
                <div class="form-group" *ngIf="videoPreview">
                  <label class="form-label">Video Preview</label>
                  <div class="video-preview-container">
                    <video [src]="videoPreview" controls class="img-thumbnail" style="max-height: 200px;"></video>
                  </div>
                </div>
              </div>

              <!-- Categories & Tags Section -->
              <div class="form-section">
                <h3 class="section-title">
                  <i class="fas fa-tags me-2"></i>Categories & Tags
                </h3>

                <!-- Categories -->
                <div class="form-group">
                  <label class="form-label">Categories</label>
                  <div class="category-grid">
                    <div class="category-item" *ngFor="let category of categories">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" 
                               [id]="'category-' + category.id"
                               [checked]="isCategorySelected(category.id)"
                               (change)="onCategoryChange(category.id, $event.target.checked)">
                        <label class="form-check-label" [for]="'category-' + category.id">
                          {{ category.name }}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tags -->
                <div class="form-group">
                  <label class="form-label">Tags</label>
                  <div class="tag-grid">
                    <div class="tag-item" *ngFor="let tag of tags">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" 
                               [id]="'tag-' + tag.id"
                               [checked]="isTagSelected(tag.id)"
                               (change)="onTagChange(tag.id, $event.target.checked)">
                        <label class="form-check-label" [for]="'tag-' + tag.id">
                          {{ tag.name }}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Settings Section -->
              <div class="form-section">
                <h3 class="section-title">
                  <i class="fas fa-cog me-2"></i>Settings
                </h3>

                <div class="form-group">
                  <div class="form-check">
                    <input type="checkbox" id="isPublic" formControlName="isPublic" class="form-check-input">
                    <label class="form-check-label" for="isPublic">
                      <strong>Public Product</strong> - Make it visible to customers immediately
                    </label>
                  </div>
                  <div class="form-text">Uncheck to save as draft and publish later.</div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg" [disabled]="productForm.invalid || isLoading">
                  <span *ngIf="!isLoading">
                    <i class="fas fa-save me-2"></i>Update Product
                  </span>
                  <app-loading-spinner *ngIf="isLoading"></app-loading-spinner>
                </button>
                <a [routerLink]="['/products/detail', productId]" class="btn btn-secondary btn-lg">
                  <i class="fas fa-times me-2"></i>Cancel
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="sr-bar">
  <div class="sr-header">
    <h3>Your Ongoing Services</h3>
    <button class="refresh-btn" (click)="fetch(true)" [disabled]="loading">
      <span *ngIf="!loading">Refresh</span>
      <span *ngIf="loading">Loading...</span>
    </button>
  </div>

  <div *ngIf="error" class="sr-error">{{ error }}</div>

  <div class="sr-empty" *ngIf="!loading && !error && items.length === 0">
    No ongoing services yet.
  </div>

  <div class="sr-list" *ngIf="!loading && !error && items.length > 0">
    <div class="sr-item" *ngFor="let it of items; trackBy: trackById">
      <div class="sr-meta">
        <div class="sr-customer" *ngIf="it.creatorUsername as uname; else noCreator">
          <img *ngIf="it.creatorProfileImageUrl" class="sr-avatar" [src]="it.creatorProfileImageUrl" alt="avatar" />
          <i class="fas fa-user" *ngIf="!it.creatorProfileImageUrl"></i>
          <span>@{{ uname }}</span>
        </div>
        <ng-template #noCreator>
          <div class="sr-customer neutral">
            <i class="fas fa-user"></i>
            <span>Creator</span>
          </div>
        </ng-template>
        <div class="sr-status" [class.purchased]="it.deliveredPurchased" [class.declined]="it.status==='Rejected'" [class.confirmed]="!it.deliveredPurchased && it.status!=='Rejected' && (it.hasDelivery || it.status==='ConfirmedByCustomer')" [class.accepted]="!it.deliveredPurchased && it.status!=='Rejected' && !it.hasDelivery && it.status==='AcceptedByCreator'" [class.pending]="!it.deliveredPurchased && it.status!=='Rejected' && !it.hasDelivery && it.status==='Pending'">
          <i class="fas fa-receipt" *ngIf="it.deliveredPurchased"></i>
          <i class="fas fa-ban" *ngIf="!it.deliveredPurchased && it.status==='Rejected'"></i>
          <i class="fas fa-box" *ngIf="!it.deliveredPurchased && it.status!=='Rejected' && it.hasDelivery"></i>
          <i class="fas fa-hourglass-half" *ngIf="!it.deliveredPurchased && it.status!=='Rejected' && !it.hasDelivery && it.status==='Pending'"></i>
          <i class="fas fa-user-check" *ngIf="!it.deliveredPurchased && it.status!=='Rejected' && !it.hasDelivery && it.status==='AcceptedByCreator'"></i>
          <i class="fas fa-check-circle" *ngIf="!it.deliveredPurchased && it.status!=='Rejected' && !it.hasDelivery && it.status==='ConfirmedByCustomer'"></i>
          <span>
            {{ it.deliveredPurchased ? 'Purchased' : (it.status==='Rejected' ? declinedByLabel(it) : (it.hasDelivery ? 'Delivered' : (it.status==='Pending' ? 'Awaiting Creator Approval' : (it.status==='AcceptedByCreator' ? 'Awaiting Customer Approval' : 'Confirmed')))) }}
          </span>
        </div>
        <div class="sr-deadline" *ngIf="!it.deliveredPurchased && it.status!=='Rejected'" [class.overdue]="it.overdue">
          <i class="far fa-clock"></i>
          <span>{{ it.timeLeft }}</span>
        </div>
      </div>
      <div class="sr-body">
        <div class="sr-req" [attr.data-id]="it.id" [class.collapsed]="!isExpanded(it.id)" [title]="it.requirements">{{ it.requirements }}</div>
        <button class="sr-toggle" *ngIf="shouldShowToggle(it)" (click)="toggleExpand(it)">
          {{ isExpanded(it.id) ? 'Read less' : 'Read more' }}
        </button>
        <div class="sr-budget" *ngIf="it.proposedBudget != null">Budget: {{ it.proposedBudget | number:'1.0-2' }} {{ it.currency || '' }}</div>
        <div class="sr-actions" *ngIf="it.status!=='Rejected'">
          <ng-container *ngIf="it.status==='AcceptedByCreator'">
            <button class="refresh-btn" (click)="confirmRequest(it)" [disabled]="loading || actionBusy===it.id" title="Accept the proposed deadline">Accept</button>
            <button class="refresh-btn" (click)="declineRequest(it)" [disabled]="loading || actionBusy===it.id" title="Decline this request">Decline</button>
          </ng-container>
          <ng-container *ngIf="!it.deliveredPurchased && it.hasDelivery">
            <button class="refresh-btn" (click)="goToProduct(it.deliveredProductId)" title="Open delivered product">Go To Product</button>
          </ng-container>
          <!-- No actions for Pending (waiting on creator) or Confirmed (handled elsewhere) -->
        </div>
      </div>
    </div>
  </div>
</div>

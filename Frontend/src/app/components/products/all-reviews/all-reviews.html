<app-alert *ngIf="errorMessage || successMessage"
  [type]="errorMessage ? 'danger' : 'success'"
  [message]="(errorMessage || successMessage) ?? ''">
</app-alert>

<div class="all-reviews-container">
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="isLoading" class="text-center mt-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="!isLoading && !error">
    <!-- Header with Stats -->
    <div class="reviews-header">
      <h2>All Reviews</h2>
      <div class="review-stats">
        <div class="average-rating">
          <span class="rating-number">{{ getAverageRating() | number:'1.1-1' }}/5</span>
          <div class="stars">
            <i class="bi bi-star-fill" *ngFor="let star of [1,2,3,4,5]"
              [class.text-warning]="star <= getAverageRating()"></i>
          </div>
          <span class="total-reviews">({{ totalReviews }} reviews)</span>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="reviews-controls d-flex justify-content-between align-items-center mb-4">
      <div class="sort-controls">
        <div class="btn-group">
          <button class="btn"
                [class.btn-primary]="sortBy === 'date'"
                [class.btn-outline-primary]="sortBy !== 'date'"
                (click)="setSortBy('date')">
            Date
            <i class="bi"
               [class.bi-sort-up]="sortBy === 'date' && sortOrder === 'asc'"
               [class.bi-sort-down]="sortBy === 'date' && sortOrder === 'desc'"></i>
          </button>
          <button class="btn"
                [class.btn-primary]="sortBy === 'rating'"
                [class.btn-outline-primary]="sortBy !== 'rating'"
                (click)="setSortBy('rating')">
            Rating
            <i class="bi"
               [class.bi-sort-up]="sortBy === 'rating' && sortOrder === 'asc'"
               [class.bi-sort-down]="sortBy === 'rating' && sortOrder === 'desc'"></i>
          </button>
        </div>
      </div>

      <div class="filter-controls">
        <span class="me-2">Filter by rating:</span>
        <div class="btn-group">
          <button *ngFor="let rating of [5,4,3,2,1]"
                  class="btn"
                  [class.btn-primary]="filterRating === rating"
                  [class.btn-outline-primary]="filterRating !== rating"
                  (click)="setFilterRating(rating)">
            {{ rating }} <i class="bi bi-star-fill"></i>
          </button>
          <button class="btn"
                  [class.btn-primary]="filterRating === null"
                  [class.btn-outline-primary]="filterRating !== null"
                  (click)="setFilterRating(null)">
            All
          </button>
        </div>
      </div>
    </div>

    <!-- Reviews List -->
    <div class="reviews-list">
      <div class="review-item card mb-3" *ngFor="let review of reviews">
        <div class="card-body">
          <div class="review-header d-flex justify-content-between align-items-start mb-3">
            <div class="reviewer-info d-flex align-items-center">
              <img [src]="review.userAvatar || '/assets/images/default-avatar.png'"
                   [alt]="review.userName"
                   class="reviewer-avatar rounded-circle me-3"
                   style="width: 48px; height: 48px; object-fit: cover;">
              <div>
                <h6 class="mb-1">{{ review.userName }}</h6>
                <div class="review-rating">
                  <i class="bi bi-star-fill text-warning"
                     *ngFor="let star of [1,2,3,4,5]"
                     [class.text-warning]="star <= review.rating"
                     [class.text-muted]="star > review.rating"></i>
                </div>
              </div>
            </div>
            <small class="text-muted">{{ review.createdAt | date:'mediumDate' }}</small>
          </div>
          <div class="review-content">
            <p class="mb-0">{{ review.comment }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <nav *ngIf="totalPages > 1" aria-label="Reviews pagination">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <button class="page-link" (click)="changePage(currentPage - 1)">
            <i class="bi bi-chevron-left"></i>
          </button>
        </li>
        <li class="page-item" *ngFor="let page of pageNumbers"
            [class.active]="page === currentPage">
          <button class="page-link" (click)="changePage(page)">{{ page }}</button>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <button class="page-link" (click)="changePage(currentPage + 1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </div>
</div>

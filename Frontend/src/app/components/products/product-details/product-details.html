<!-- Product Details Page - Epic Games Style -->
<app-alert *ngIf="errorMessage || successMessage"
  [type]="errorMessage ? 'error' : 'success'"
  [message]="errorMessage || successMessage || ''"
  (close)="errorMessage = null; successMessage = null">
</app-alert>

<div class="product-details-container" *ngIf="!isLoading && !error">
  <!-- Simplified Header -->
  <header class="product-header sticky">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <nav class="breadcrumb-nav">
            <a routerLink="/discover" class="breadcrumb-link">
              <i class="fas fa-arrow-left"></i>
              Back to Discover
            </a>

            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">{{ product?.categories?.[0]?.name }}</span>

            <span><i class="bi bi-currency-dollar"></i> {{ product?.price | currency:product?.currency:'symbol' }}</span>
          </nav>
        </div>
        <div class="col-lg-4 text-end">
          <div class="header-actions">
            <span class="product-rating">
                <span class="stars">
                  <i class="bi bi-star-fill" *ngFor="let star of [1,2,3,4,5]"
                     [class.text-warning]="star <= (product?.averageRating || 0)"
                     [class.text-muted]="star > (product?.averageRating || 0)"></i>
                </span>

            </span>
            <button class="btn btn-outline btn-sm" (click)="shareProduct()">
              <i class="bi bi-share"></i>
              Share
            </button>
            <button 
              *ngIf="!hasPurchased"
              class="btn btn-outline btn-sm" 
              (click)="toggleWishlist()">
              <i class="fas fa-heart" [class.text-danger]="isInWishlist"></i>
              {{ isInWishlist ? 'In Wishlist' : 'Add to Wishlist' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Product Summary Section -->
  <!-- <section class="product-summary">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="product-info">
                         <h1 class="product-title">{{ product?.name }}</h1>
                         <p class="product-creator">by {{ product?.creatorUsername }}</p>
            <div class="product-meta">
              <div class="product-rating">
                <div class="stars">
                  <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]"
                     [class.text-warning]="star <= (product?.rating || 0)"></i>
                </div>
                <span class="rating-text">{{ product?.rating | number:'1.1-1' }} ({{ product?.ratingCount }} reviews)</span>
              </div>
              <div class="product-category">
                <span class="category-badge">{{ product?.category }}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <!-- <div class="purchase-card">
            <div class="price-section">
              <span class="product-price">${{ product?.price }}</span>
              <span class="original-price" *ngIf="product?.originalPrice">${{ product?.originalPrice }}</span>
            </div>
            <div class="purchase-actions">
              <button class="btn btn-primary btn-lg w-100 mb-3" 
                      (click)="addToCart()" 
                      [disabled]="isCartButtonDisabled()">
                <i class="fas fa-shopping-cart" *ngIf="!checkingCartStatus"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="checkingCartStatus"></i>
                {{ getCartButtonText() }}
              </button>
              <button class="btn btn-outline btn-lg w-100" (click)="buyNow()">
                <i class="fas fa-bolt"></i>
                Buy Now
              </button>
            </div>
            <div class="product-badges" *ngIf="product?.badges?.length">
              <span class="badge" *ngFor="let badge of product?.badges">{{ badge }}</span>
            </div>
          </div> -->
        <!-- </div>
      </div>
    </div>
  </section> -->

  <!-- Product Details Section -->
  <section class="product-details-section">
    <div class="container">
      <div class="row">
        <!-- Product Media Gallery -->
        <div class="col-lg-8">
          <div class="product-gallery">
            <div class="main-media">
              <div class="media-container" *ngIf="!selectedMedia.type || selectedMedia.type === 'image'">
                <img [src]="product?.coverImageUrl || selectedMedia.url" [alt]="product?.name" class="main-image">
              </div>
              <div class="media-container" *ngIf="selectedMedia.type === 'video'">
                <iframe
                  [src]="product?.previewVideoUrl || selectedMedia.url"
                  title="Product Video"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allowfullscreen
                  class="main-video">
                </iframe>
              </div>
            </div>

            <div class="media-thumbnails" *ngIf="product?.coverImageUrl || product?.previewVideoUrl">
              <div
                class="thumbnail"
                *ngFor="let mediaItem of getMediaItems(); let i = index"
                [class.active]="selectedMediaIndex === i"
                (click)="selectMedia(i)"
              >
                <img [src]="mediaItem.thumbnail || mediaItem.url" [alt]="product?.name">
                <div class="media-type-indicator" *ngIf="mediaItem.type === 'video'">
                  <i class="fas fa-play"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Description -->
          <div class="product-description">
            <h3>Description</h3>
            <div class="description-content" [innerHTML]="product?.description"></div>

            <!-- Product Features -->
            <div class="product-features" *ngIf="product?.features?.length">
              <h4>Features</h4>
              <ul class="features-list">
                <li *ngFor="let feature of product?.features">
                  <i class="fas fa-check"></i>
                  {{ feature }}
                </li>
              </ul>
            </div>

            <!-- Product Tags -->
            <div class="product-tags" *ngIf="product?.tags?.length">
              <h4>Tags</h4>
              <div class="tags-container">
                <span class="tag" *ngFor="let tag of product?.tags">{{ tag.name }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Sidebar -->
        <div class="col-lg-4">
          <div class="product-sidebar">
            <!-- Purchase Card (Sticky) -->
            <div class="purchase-card">
              <div class="price-section">
                <span class="product-price">{{ product?.price | currency:product?.currency:'symbol' }}</span>
              </div>
              <div class="purchase-actions">
                <button 
                  class="btn btn-lg w-100 mb-3" 
                  [class.btn-primary]="!hasPurchased && !isInCart"
                  [class.btn-info]="!hasPurchased && isInCart"
                  [class.btn-success]="hasPurchased"
                  (click)="hasPurchased ? goToLibrary() : addToCart()"
                  [disabled]="loadingPurchaseStatus || checkingCartStatus">
                  <i class="fas" 
                     [class.fa-shopping-cart]="!hasPurchased && !isInCart" 
                     [class.fa-eye]="!hasPurchased && isInCart"
                     [class.fa-book]="hasPurchased"></i>
                  {{ hasPurchased ? 'In Library' : getCartButtonText() }}
                </button>
                <!-- Wishlist Toggle Button (Only for logged-in users who haven't purchased) -->
                <button 
                  *ngIf="isLoggedIn() && !hasPurchased" 
                  class="btn btn-lg w-100 wishlist-btn"
                  [class.btn-outline]="!isInWishlist"
                  [class.btn-success]="isInWishlist"
                  [class.loading]="loadingWishlist"
                  [class.hovered]="wishlistHovered"
                  [disabled]="loadingWishlist"
                  (click)="toggleWishlist($event)"
                  (mouseenter)="onWishlistHover(true, $event)"
                  (mouseleave)="onWishlistHover(false, $event)"
                >
                  <!-- Loading Spinner -->
                  <i class="fas fa-spinner fa-spin" *ngIf="loadingWishlist"></i>
                  <!-- Plus Icon (not in wishlist) -->
                  <i class="fas fa-plus" *ngIf="!isInWishlist && !loadingWishlist"></i>
                  <!-- Checkmark Icon (in wishlist) -->
                  <i class="fas fa-check" *ngIf="isInWishlist && !loadingWishlist"></i>
                  <!-- Dynamic Text -->
                  <span *ngIf="!loadingWishlist">
                    {{ isInWishlist ? 'In Wishlist' : 'Add To Wishlist' }}
                  </span>
                  <span *ngIf="loadingWishlist">Processing...</span>
                </button>

                <!-- Login Required Message for Anonymous Users -->
                <button 
                  *ngIf="!isLoggedIn()" 
                  class="btn btn-outline btn-lg w-100"
                  (click)="navigateToLogin()"
                >
                  <i class="fas fa-sign-in-alt"></i>
                  Login to Add to Wishlist
                </button>
              </div>
            </div>

            <!-- Product Details -->
            <div class="product-details-card">
              <h5>Product Details</h5>
              <div class="detail-item" *ngIf="product?.files?.length">
                <span class="detail-label">Files:</span>
                <span class="detail-value">{{ product?.files?.length }} files</span>
              </div>
              <div class="detail-item" *ngIf="calculateTotalFileSize(product?.files)">
                <span class="detail-label">Total Size:</span>
                <span class="detail-value">{{ calculateTotalFileSize(product?.files) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Compatibility:</span>
                <span class="detail-value">{{ product?.compatibility }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">License:</span>
                <span class="detail-value">{{ product?.license }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Updates:</span>
                <span class="detail-value">{{ product?.updates }}</span>
              </div>
            </div>

            <!-- Creator Info -->
            <!-- <div class="creator-card">
              <div class="creator-header">
                <img [src]="product?.creatorAvatar" [alt]="product?.creator" class="creator-avatar">
                <div class="creator-info">
                  <h6>{{ product?.creator }}</h6>
                  <p class="creator-stats">{{ product?.creatorProducts }} products</p>
                </div>
              </div>
              <button class="btn btn-outline w-100" (click)="viewCreator()">
                <i class="fas fa-user"></i>
                View Creator
              </button>
            </div> -->

            <!-- Reviews Summary -->
            <div class="reviews-summary">
              <h5>Customer Reviews</h5>
              <div class="overall-rating">
                <div class="rating-stars">
                  <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]"
                     [class.text-warning]="star <= (product?.averageRating || 0)"></i>
                </div>
                <span class="rating-number">{{ product?.averageRating | number:'1.1-1' }}/5</span>
                <span class="rating-count">({{ product?.reviews?.length || 0 }} reviews)</span>
              </div>

              <!-- Rating Distribution -->
              <div class="rating-distribution">
                <div class="rating-bar" *ngFor="let rating of [5,4,3,2,1]">
                  <span class="rating-label">{{ rating }}â˜…</span>
                  <div class="rating-progress">
                    <div class="progress-bar" [style.width.%]="getRatingPercentage(rating)"></div>
                  </div>
                  <span class="rating-count">{{ getRatingCount(rating) }}</span>
                </div>
              </div>
            </div>

            <!-- View All Reviews Link -->
            <div class="view-all-reviews text-center mt-4">
              <a [routerLink]="['/products', product?.id, 'reviews']" class="btn btn-outline-primary load-reviews-btn">
                <i class="fas fa-list me-2"></i>
                View All Reviews
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Reviews Section -->
  <section class="reviews-section">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h3>Customer Reviews</h3>

          <!-- Review Section for Logged In Users -->
          <div class="review-section mb-4" *ngIf="isLoggedIn()">
            
            <!-- Loading Purchase Status -->
            <div *ngIf="loadingPurchaseStatus" class="text-center py-3">
              <i class="fas fa-spinner fa-spin"></i>
              <span class="ms-2">Checking purchase status...</span>
            </div>

            <!-- User hasn't purchased - Show purchase requirement -->
            <div *ngIf="!loadingPurchaseStatus && !hasPurchased" class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Purchase Required:</strong> You need to purchase this product before you can write a review.
            </div>

            <!-- User has purchased - Show review form or existing review -->
            <div *ngIf="!loadingPurchaseStatus && hasPurchased">
              
              <!-- Existing Review Display (when not editing) -->
              <!-- <div *ngIf="existingReview && !isEditingReview" class="existing-review-display mb-4">
                <h4>Your Review</h4>
                <div class="review-card card">
                  <div class="card-body">
                    <div class="rating-display mb-2">
                      <span>Your Rating: </span>
                      <div class="stars d-inline-block">
                        <i class="bi bi-star-fill text-warning" *ngFor="let star of [1,2,3,4,5]"
                           [class.text-muted]="star > existingReview.Rating"></i>
                      </div>
                      <span class="ms-2">({{ existingReview.Rating }}/5)</span>
                    </div>
                    <p class="review-comment" *ngIf="existingReview.Comment">{{ existingReview.Comment }}</p>
                    <p class="review-comment text-muted" *ngIf="!existingReview.Comment">No comment provided</p>
                    <small class="text-muted">Reviewed on {{ existingReview.CreatedAt | date:'mediumDate' }}</small>
                    <div class="review-actions mt-3">
                      <button class="btn btn-outline-primary btn-sm me-2" (click)="editReview()" title="Edit Review">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteReview()" title="Delete Review">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div> -->

              <!-- Review Form (for new reviews or editing) -->
               <div *ngIf="!existingReview || isEditingReview" class="add-review-form">
                <h4>{{ existingReview ? 'Edit Your Review' : 'Write a Review' }}</h4>
                <div class="rating-input mb-3">
                  <span>Your Rating: </span>
                  <div class="stars">
                    <i class="bi bi-star-fill" *ngFor="let star of [1,2,3,4,5]"
                       [class.text-warning]="star <= userRating"
                       [class.text-muted]="star > userRating"
                       (click)="setUserRating(star)"
                       style="cursor: pointer;"></i>
                  </div>
                </div>
                <div class="form-group">
                  <label for="reviewComment">Your Review:</label>
                  <textarea class="form-control" id="reviewComment" rows="4"
                            [(ngModel)]="userReview"
                            [disabled]="submittingReview"
                            placeholder="Share your experience with this product..."></textarea>
                </div>
                <div class="form-actions mt-3">
                  <button class="btn btn-primary me-2"
                          (click)="submitReview()"
                          [disabled]="submittingReview || !userRating || !userReview.trim()">
                    <i class="fas fa-spinner fa-spin me-1" *ngIf="submittingReview"></i>
                    {{ submittingReview 
                       ? 'Saving...' 
                       : existingReview 
                         ? 'Update Review' 
                         : 'Submit Review' }}
                  </button>
                  <button *ngIf="isEditingReview" 
                          class="btn btn-outline-secondary"
                          (click)="cancelEdit()"
                          [disabled]="submittingReview">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Message for Non-Logged In Users -->
          <div *ngIf="!isLoggedIn()" class="alert alert-warning">
            <i class="fas fa-sign-in-alt me-2"></i>
            <strong>Login Required:</strong> Please <a [routerLink]="['/login']" class="alert-link">login</a> to write a review.
          </div>

          <div class="reviews-container">
            <!-- Show reviews if they exist -->
            <div class="review-item card mb-3" *ngFor="let review of reviews.slice(0, 3)">
              <div class="card-body">
                <div class="review-header d-flex justify-content-between align-items-start mb-3">
                  <div class="reviewer-info d-flex align-items-center">
                    <img [src]="review.userAvatar || getPlaceholderAvatar(review.userName)"
                         [alt]="review.userName"
                         class="reviewer-avatar rounded-circle me-3"
                         style="width: 48px; height: 48px; object-fit: cover;">
                    <div>
                      <h6 class="mb-1">
                        {{ review.userName}}
                        <span *ngIf="isMyReview(review)" class="badge bg-primary ms-2">You</span>
                      </h6>
                      <div class="review-rating">
                        <i class="bi bi-star-fill"
                           *ngFor="let star of [1,2,3,4,5]"
                           [class.text-warning]="star <= review.rating"
                           [class.text-muted]="star > review.rating"></i>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <small class="text-white">{{ review.createdAt | date:'mediumDate' }}</small>
                    <!-- Edit/Delete buttons for user's own reviews -->
                    <div *ngIf="isMyReview(review)" class="review-actions">
                      <button class="btn btn-outline-primary btn-sm me-1" 
                              (click)="editSpecificReview(review)" 
                              title="Edit Review">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-outline-danger btn-sm" 
                              (click)="deleteSpecificReview(review)" 
                              title="Delete Review">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="review-content">
                  <p class="mb-0" *ngIf="review.comment">{{ review.comment }}</p>
                  <p class="mb-0 text-white fst-italic" *ngIf="!review.comment">No comment provided.</p>
                </div>
              </div>
            </div>
            
            <!-- Show "no reviews" message if no reviews exist -->
            <div *ngIf="!reviews || reviews.length === 0" class="no-reviews text-center py-4">
              <i class="fas fa-star-o fa-3x text-muted mb-3"></i>
              <h5 class="text-white">No Reviews Yet</h5>
              <p class="text-white">Be the first to review this product!</p>
            </div>
          </div>

          <!-- View All Reviews Button -->
          <div class="view-all-reviews text-center mt-4">
            <button class="btn btn-outline-primary" [routerLink]="['/products', product?.id, 'reviews']">
              <i class="bi bi-list me-2"></i>
              View All Reviews ({{ product?.reviews?.length || 0 }})
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Related Products -->
  <!-- <section class="related-products">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h3>You Might Also Like</h3>
          <div class="related-products-grid">
            <div class="related-product-card" *ngFor="let relatedProduct of relatedProducts">
              <div class="product-image">
                                 <img [src]="relatedProduct.coverImageUrl" [alt]="relatedProduct.name">
              </div>
              <div class="product-info">
                                 <h6>{{ relatedProduct.name }}</h6>
                                 <div class="creator">by {{ relatedProduct.creatorUsername }}</div>
                <div class="product-meta">
                                     <div class="price">{{ relatedProduct.price | currency:relatedProduct.currency:'symbol' }}</div>
                  <div class="rating">
                                         <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]"
                        [class.text-warning]="star <= (relatedProduct.averageRating || 0)"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section> -->
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="isLoading">
  <div class="loading-content">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <h4 class="mt-3">Loading product details...</h4>
    <p class="text-muted">Please wait while we fetch the product information.</p>
  </div>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="error">
  <div class="error-content">
    <div class="error-icon">
      <i class="fas fa-exclamation-triangle text-danger"></i>
    </div>
    <h4 class="mt-3">Product Not Found</h4>
    <p class="text-muted">{{ error }}</p>
    <div class="error-actions">
      <button class="btn btn-primary" routerLink="/discover">
        <i class="fas fa-arrow-left me-2"></i>
        Back to Discover
      </button>
      <button class="btn btn-outline" (click)="loadProduct()">
        <i class="fas fa-redo me-2"></i>
        Try Again
      </button>
    </div>
  </div>
</div>



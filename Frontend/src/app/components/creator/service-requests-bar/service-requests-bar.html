<div class="sr-bar">
  <div class="sr-header">
    <h3>Active Service Requests</h3>
    <button class="refresh-btn" (click)="fetch(true)" [disabled]="loading">
      <span *ngIf="!loading">Refresh</span>
      <span *ngIf="loading">Loading...</span>
    </button>
  </div>

  <div *ngIf="error" class="sr-error">{{ error }}</div>

  <div class="sr-empty" *ngIf="!loading && !error && items.length === 0">
    No active service requests yet.
  </div>

  <div class="sr-list" *ngIf="!loading && !error && items.length > 0">
    <div class="sr-item" *ngFor="let it of items; trackBy: trackById">
      <div class="sr-meta">
        <div class="sr-customer" *ngIf="it.customerUsername as uname; else noName">
          <img *ngIf="it.customerProfileImageUrl" class="sr-avatar" [src]="it.customerProfileImageUrl" alt="avatar" />
          <i class="fas fa-user" *ngIf="!it.customerProfileImageUrl"></i>
          <span>@{{ uname }}</span>
        </div>
        <ng-template #noName>
          <div class="sr-customer neutral">
            <i class="fas fa-user"></i>
            <span>Customer</span>
          </div>
        </ng-template>
        <div class="sr-status" [class.confirmed]="it.status==='ConfirmedByCustomer'" [class.accepted]="it.status==='AcceptedByCreator'" [class.pending]="it.status==='Pending'">
          <i class="fas fa-hourglass-half" *ngIf="it.status==='Pending'"></i>
          <i class="fas fa-user-check" *ngIf="it.status==='AcceptedByCreator'"></i>
          <i class="fas fa-check-circle" *ngIf="it.status==='ConfirmedByCustomer'"></i>
          <span>
            {{ it.status==='Pending' ? 'Awaiting Creator Approval' : (it.status==='AcceptedByCreator' ? 'Awaiting Customer Approval' : 'Confirmed') }}
          </span>
        </div>
        <div class="sr-deadline" [class.overdue]="it.overdue">
          <i class="far fa-clock"></i>
          <span>{{ it.timeLeft }}</span>
        </div>
      </div>
      <div class="sr-body">
        <div class="sr-req" [attr.data-id]="it.id" [class.collapsed]="!isExpanded(it.id)" [title]="it.requirements">{{ it.requirements }}</div>
        <button class="sr-toggle" *ngIf="shouldShowToggle(it)" (click)="toggleExpand(it)">
          {{ isExpanded(it.id) ? 'Read less' : 'Read more' }}
        </button>
        <div class="sr-budget">Budget: {{ it.proposedBudget != null ? (it.proposedBudget | number:'1.0-2') : 'â€”' }} {{ it.currency || '' }}</div>
        <div class="sr-actions" *ngIf="!it.overdue">
          <!-- Before both confirmations: show Accept/Decline for creator when Pending -->
          <ng-container *ngIf="it.status==='Pending'; else postAcceptActions">
            <button class="refresh-btn" (click)="acceptWithDeadline(it)" [disabled]="loading || actionBusy===it.id" title="Accept and set deadline">Accept</button>
            <button class="refresh-btn" (click)="declineRequest(it)" [disabled]="loading || actionBusy===it.id" title="Decline this request">Decline</button>
          </ng-container>
          <ng-template #postAcceptActions>
            <!-- After both confirmations only -->
            <button class="refresh-btn" (click)="updateDeadline(it)" [disabled]="loading || actionBusy===it.id || it.status !== 'ConfirmedByCustomer'" title="Propose a new deadline">Request Extension</button>
            <button class="refresh-btn" (click)="deliver(it)" [disabled]="loading || actionBusy===it.id || it.status !== 'ConfirmedByCustomer'" title="Allowed after customer confirmation">Deliver</button>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
